<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brainfuck WASM Test</title>
    <style>
      body {
        font-family: monospace;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      textarea {
        width: 100%;
        height: 150px;
        font-family: monospace;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      #output,
      #tape {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        word-wrap: break-word;
      }
      .tape-cell {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        text-align: center;
        line-height: 30px;
        margin: 2px;
        font-size: 12px;
      }
      .tape-cell.current {
        background: #ffeb3b;
        font-weight: bold;
      }
      .tape-cell.non-zero {
        background: #e3f2fd;
      }
    </style>
  </head>
  <body>
    <h1>Brainfuck WASM Interpreter Test</h1>

    <div class="section">
      <h2>Configuration</h2>
      <label>
        Tape Size:
        <input type="number" id="tapeSize" value="100" min="10" max="30000" />
      </label>
      <label>
        Cell Size:
        <select id="cellSize">
          <option value="8">8-bit</option>
          <option value="16">16-bit</option>
          <option value="32">32-bit</option>
        </select>
      </label>
      <label> <input type="checkbox" id="wrap" checked /> Cell Wrapping </label>
      <label>
        <input type="checkbox" id="wrapTape" checked /> Tape Wrapping
      </label>
      <label>
        <input type="checkbox" id="optimize" checked /> Optimize Code
      </label>
    </div>

    <div class="section">
      <h2>Brainfuck Code</h2>
      <textarea id="code" placeholder="Enter Brainfuck code here...">
++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.>---.+++++++..+++.>>.<-.<.+++.------.--------.>>+.>++.</textarea
      >
      <br />
      <button onclick="runCode()">Run</button>
      <button onclick="runCodeWithCallback()">Run with Real-time Output</button>
      <button onclick="loadHelloWorld()">Load Hello World</button>
      <button onclick="loadFizzBuzz()">Load FizzBuzz (1-30)</button>
      <button onclick="optimizeCode()">Show Optimized Code</button>
    </div>

    <div class="section">
      <h2>Input</h2>
      <textarea id="input" placeholder="Program input (optional)"></textarea>
    </div>

    <div class="section">
      <h2>Output</h2>
      <div id="output"></div>
    </div>

    <div class="section">
      <h2>Real-time Output (with callback)</h2>
      <div
        id="realtime-output"
        style="background: #f0f8ff; min-height: 50px"
      ></div>
    </div>

    <div class="section">
      <h2>Tape State (First 50 cells)</h2>
      <div>Pointer Position: <span id="pointer">0</span></div>
      <div id="tape"></div>
    </div>

    <div class="section">
      <h2>Optimized Code</h2>
      <div id="optimized" style="word-wrap: break-word"></div>
    </div>

    <script type="module">
      import init, { BrainfuckInterpreter } from './pkg/bf_wasm.js';

      let wasmModule = null;

      async function initWasm() {
        wasmModule = await init();
        console.log('WASM module loaded');
        document.getElementById('output').textContent =
          'WASM module loaded. Ready to run!';
      }

      window.runCode = function () {
        if (!wasmModule) {
          alert('WASM module not loaded yet');
          return;
        }

        const code = document.getElementById('code').value;
        const input = document.getElementById('input').value;
        const tapeSize = parseInt(document.getElementById('tapeSize').value);
        const cellSize = parseInt(document.getElementById('cellSize').value);
        const wrap = document.getElementById('wrap').checked;
        const wrapTape = document.getElementById('wrapTape').checked;
        const optimize = document.getElementById('optimize').checked;

        try {
          const interpreter = BrainfuckInterpreter.with_options(
            tapeSize,
            cellSize,
            wrap,
            wrapTape,
            optimize,
          );

          const inputBytes = new TextEncoder().encode(input);
          const result = interpreter.run_program(code, inputBytes);

          // Display output
          document.getElementById('output').textContent =
            result.output || '(no output)';

          // Display pointer position
          document.getElementById('pointer').textContent = result.pointer;

          // Display tape (first 50 cells)
          const tapeDiv = document.getElementById('tape');
          tapeDiv.innerHTML = '';
          const cellsToShow = Math.min(50, result.tape.length);
          for (let i = 0; i < cellsToShow; i++) {
            const cell = document.createElement('div');
            cell.className = 'tape-cell';
            if (i === result.pointer) {
              cell.className += ' current';
            }
            if (result.tape[i] !== 0) {
              cell.className += ' non-zero';
            }
            cell.textContent = result.tape[i];
            cell.title = `Cell ${i}: ${result.tape[i]}`;
            tapeDiv.appendChild(cell);
          }
        } catch (error) {
          document.getElementById('output').textContent =
            'Error: ' + error.message;
          console.error(error);
        }
      };

      window.runCodeWithCallback = function () {
        if (!wasmModule) {
          alert('WASM module not loaded yet');
          return;
        }

        const code = document.getElementById('code').value;
        const input = document.getElementById('input').value;
        const tapeSize = parseInt(document.getElementById('tapeSize').value);
        const cellSize = parseInt(document.getElementById('cellSize').value);
        const wrap = document.getElementById('wrap').checked;
        const wrapTape = document.getElementById('wrapTape').checked;
        const optimize = document.getElementById('optimize').checked;

        // Clear real-time output
        const realtimeDiv = document.getElementById('realtime-output');
        realtimeDiv.innerHTML =
          '<span style="color: #888;">Running...</span><br>';

        try {
          const interpreter = BrainfuckInterpreter.with_options(
            tapeSize,
            cellSize,
            wrap,
            wrapTape,
            optimize,
          );

          const inputBytes = new TextEncoder().encode(input);

          // Create output callback
          const outputCallback = (char, charCode) => {
            // Append character to real-time output
            const span = document.createElement('span');
            if (charCode === 10) {
              span.innerHTML = '<br>';
            } else {
              span.textContent = char;
            }
            realtimeDiv.appendChild(span);

            // Optional: Auto-scroll to bottom
            realtimeDiv.scrollTop = realtimeDiv.scrollHeight;
          };

          // Run with callback
          const result = interpreter.run_program_with_callback(
            code,
            inputBytes,
            outputCallback,
          );

          // Display final state
          document.getElementById('output').textContent =
            result.output || '(no output)';
          document.getElementById('pointer').textContent = result.pointer;

          // Display tape
          const tapeDiv = document.getElementById('tape');
          tapeDiv.innerHTML = '';
          const cellsToShow = Math.min(50, result.tape.length);
          for (let i = 0; i < cellsToShow; i++) {
            const cell = document.createElement('div');
            cell.className = 'tape-cell';
            if (i === result.pointer) {
              cell.className += ' current';
            }
            if (result.tape[i] !== 0) {
              cell.className += ' non-zero';
            }
            cell.textContent = result.tape[i];
            cell.title = `Cell ${i}: ${result.tape[i]}`;
            tapeDiv.appendChild(cell);
          }

          // Mark as complete
          const completeSpan = document.createElement('span');
          completeSpan.innerHTML =
            '<br><span style="color: green;">âœ“ Complete</span>';
          realtimeDiv.appendChild(completeSpan);
        } catch (error) {
          realtimeDiv.innerHTML =
            '<span style="color: red;">Error: ' + error.message + '</span>';
          console.error(error);
        }
      };

      window.optimizeCode = function () {
        if (!wasmModule) {
          alert('WASM module not loaded yet');
          return;
        }

        const code = document.getElementById('code').value;

        try {
          const interpreter = new BrainfuckInterpreter();
          const optimized = interpreter.optimize_brainfuck(code);
          document.getElementById('optimized').textContent = optimized;
        } catch (error) {
          document.getElementById('optimized').textContent =
            'Error: ' + error.message;
        }
      };

      window.loadHelloWorld = function () {
        document.getElementById('code').value =
          '++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.>---.+++++++..+++.>>.<-.<.+++.------.--------.>>+.>++.';
      };

      window.loadFizzBuzz = function () {
        // Simple FizzBuzz for 1-30
        document.getElementById('code').value = `
++++++++++[>++++++++++<-]>                 # Set cell 0 to 100 (for modulo operations)
>>++++++++++[<++++++++++>-]<               # Set cell 2 to 100
>+++++++++++++++                           # Set cell 3 to 15 (counter)

[                                           # Main loop
    >++++++++++[<++++++++++>-]<.           # Print number (simplified)
    [-]>[-]>[-]>[-]<<<<                    # Clear cells
    -                                       # Decrement counter
]
            `
          .replace(/#.*$/gm, '')
          .replace(/\s/g, '');
      };

      // Initialize WASM on page load
      initWasm();
    </script>
  </body>
</html>
